import Head from "next/head";

import { Dashboard } from "../components/Dashboard";
import { useRouter } from "next/router";
import { useSession } from "next-auth/react";

import { useRecoilState } from "recoil";
import SpotifyWebApi from "spotify-web-api-node";
import { useCallback, useEffect, useState } from "react";

import { playingTrackState } from "../atoms/playerAtom";
import { Body } from "../components/template/Body";
import { SidebarLayout } from "../components/template/SidebarLayout";
import { Loader } from "../components/atoms/Loader";
import { NextPage } from "next";

const spotifyApi = new SpotifyWebApi({
  clientId: process.env.SPOTIFY_CLIENT_ID,
});

const Home: NextPage = () => {
  const router = useRouter();
  //playerを表示させるために必要
  const { data: session } = useSession();
  const [playingTrack, setPlayingTrack] = useRecoilState(playingTrackState);

  // プレイヤーバーの表示ステータス
  const [showPlayer, setShowPlayer] = useState(false);

  //  プレイヤーバーを表示
  useEffect(() => {
    setShowPlayer(true);
  }, []);

  //曲を再生
  const chooseTrack = useCallback(
    (track: any): any => {
      setPlayingTrack(track);
    },
    [setPlayingTrack]
  );

  // useSessionで session 情報と status 状態を保持する変数を作成
  const { status } = useSession({
    required: true,
    onUnauthenticated() {
      // 認証されていないのでサインインページに飛ばす。
      router.push("/auth/signin");
    },
  });

  if (status === "loading") {
    return <Loader />;
  }

  return (
    <div>
      <Head>
        <title>Music-player</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <SidebarLayout>
        <Body spotifyApi={spotifyApi} chooseTrack={chooseTrack} />
      </SidebarLayout>
    </div>
  );
};

export default Home;
